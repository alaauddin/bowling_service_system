{% extends 'base.html' %}
{% block content %}

<style>
/* üîπ Lane Card */
.lane-card { transition: all 0.3s ease; border-radius: 0.75rem; }
.lane-card:hover { transform: translateY(-5px) scale(1.02); }
.lane-header {
    height: 90px;
    background: linear-gradient(135deg, var(--primary, #007bff), var(--secondary, #00d4ff));
    text-align: center; position: relative;
}
.lane-number {
    color: #fff; text-shadow: 0 0 6px rgba(255,255,255,0.6);
    position: absolute; left: 50%; top: 35%;
    transform: translateX(-50%);
    font-size: 2.5rem;
}
.note-indicator {
    position: absolute; top: 6px; right: 8px;
    font-size: 2.2rem; color: #dc3545;
    animation: glow 1.6s infinite;
}
@keyframes glow { 0% { text-shadow: 0 0 0 #dc3545;} 50% { text-shadow: 0 0 8px #dc3545;} 100% { text-shadow: 0 0 0 #dc3545;} }
.error-badge {
    position: absolute; top: 4px; left: 50%;
    transform: translateX(-50%);
}
.error-badge .badge { font-size: 0.7rem; padding: 0.2rem 0.5rem; }
.btn-action { border-radius: 20px; padding: 0.25rem 0.6rem; }
.btn-glow {
    margin-top: 15px;
    background: linear-gradient(90deg, #68afffff, #ffcd57ff, #5cabffff);
    background-size: 300% 100%;
    color: #fff !important;
    border: none;
    border-radius: 12px;
    font-weight: bold;
    animation: glowing 6s linear infinite, pulse 1.5s ease-in-out infinite, bounceScale 1.8s cubic-bezier(.68,-0.55,.27,1.55) infinite;
    box-shadow: 0 0 12px 2px #68afff88, 0 0 24px 4px #ffcd5788;
    transition: transform 0.2s ease-in-out, box-shadow 0.3s;
}
.btn-glow:hover {
    transform: scale(1.18) rotate(-2deg);
    box-shadow: 0 0 24px 6px #ffcd57cc, 0 0 32px 8px #5cabffcc;
}
@keyframes glowing {
    0%   { background-position: 0% 50%; }
    50%  { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
}
@keyframes pulse {
    0% { box-shadow: 0 0 12px 2px #68afff88, 0 0 24px 4px #ffcd5788; }
    50% { box-shadow: 0 0 32px 8px #ffcd57cc, 0 0 40px 12px #5cabffcc; }
    100% { box-shadow: 0 0 12px 2px #68afff88, 0 0 24px 4px #ffcd5788; }
}
@keyframes bounceScale {
    0%   { transform: scale(1); }
    20%  { transform: scale(1.12); }
    40%  { transform: scale(0.92); }
    60%  { transform: scale(1.08); }
    80%  { transform: scale(0.98); }
    100% { transform: scale(1); }
}
</style>

<!-- üîπ Header with Actions -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-3">
    <h2 class="welcome-text h3 fw-bold mb-2 mb-md-0 fade-in-title">
        <i class="bi bi-diagram-3-fill me-1 text-accent"></i>
        ŸÜÿ∏ÿ±ÿ© ÿπÿßŸÖÿ© ÿπŸÑŸâ ÿßŸÑŸÇÿ≥ŸÖ: {{ section.name }}
    </h2>
    <div class="d-flex flex-wrap gap-2 mt-2 mt-md-0">
        <a href="{% url 'my_repairs' %}" class="btn btn-dark"><i class="bi bi-tools me-1"></i> ÿ•ÿµŸÑÿßÿ≠ÿßÿ™Ÿä</a>
        <a href="{% url 'broken_lane_resolves' %}" class="btn btn-danger"><i class="bi bi-exclamation-octagon-fill me-1"></i> ÿ≠ŸÑ ÿßŸÑŸÖÿ≥ÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿπÿ∑ŸÑÿ©</a>
        <a href="{% url 'all_error_logs' %}" class="btn btn-warning"><i class="bi bi-bug-fill me-1"></i> ŸÉŸÑ ÿ≥ÿ¨ŸÑÿßÿ™ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°</a>
        <a href="{% url 'all_errors' %}" class="btn btn-info"><i class="bi bi-exclamation-triangle-fill me-1"></i> ŸÉŸÑ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°</a>
    </div>
</div>

<!-- üîπ Lanes -->
<div class="row g-2 justify-content-center">
    {% if lanes %}
    {% for lane in lanes %}
    <div class="col-lg-3 col-md-4 col-6">
        <div class="card lane-card shadow-sm h-100">
            <div class="card-header lane-header">
                <!-- Lane Number -->
                <span class="lane-number display-1 fw-bold">{{ lane.number }}</span>
                <!-- Pending Note (top-right corner) -->
                {% with notes=note|dictsort:"created_at" %}
                {% for n in notes %}
                    {% if n.lane.id == lane.id %}
                        <a href="{% url 'edit_note_pending_app2' n.id %}" class="note-indicator" title="ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ÿ∫Ÿäÿ± ŸÖÿ≠ŸÑŸàŸÑÿ©">
                            <i class="bi bi-exclamation-triangle-fill"></i>
                        </a>
                        {% comment %} break removed, only first matching note will show indicator {% endcomment %}
                        {% endif %}
                {% endfor %}
                {% endwith %}
                <!-- Error Count (below number) -->
                {% if lane.get_error_logs_count > 0 %}
                    <div class="error-badge">
                        <span class="badge bg-danger small">ÿ£ÿÆÿ∑ÿßÿ°: {{ lane.get_error_logs_count }}</span>
                    </div>
                {% endif %}
            </div>
            <div class="card-body p-2 d-flex flex-column justify-content-end">
                <!-- Notes -->
                {% with notes=note|dictsort:"created_at" %}
                {% for n in notes %}
                    {% if n.lane.id == lane.id %}
                        <div class="alert alert-warning d-flex justify-content-between align-items-center">
                            <div><i class="bi bi-sticky me-1"></i> ŸÖŸÑÿßÿ≠ÿ∏ÿ© ŸÖÿπŸÑŸÇÿ©: {{ n.note }}</div>
                            <a href="{% url 'edit_note_pending_app2' n.id %}" class="btn btn-sm btn-outline-success">ÿ≠ŸÑ</a>
                        </div>
                    {% endif %}
                {% endfor %}
                {% endwith %}
                <div class="d-flex flex-wrap justify-content-center gap-1 mt-2">
                    <a href="{% url 'lane_errors' lane.id %}" class="btn btn-action btn-sm btn-primary d-flex align-items-center gap-1" title="ÿπÿ±ÿ∂ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°">
                        <i class="bi bi-eye-fill"></i> <span>ÿπÿ±ÿ∂ ÿßŸÑÿ£ÿÆÿ∑ÿßÿ°</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}

    {% else %}
    <div class="col-12 text-center">
        <p class="alert alert-info small mt-3">‚ú® ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖÿ≥ÿßÿ±ÿßÿ™ ÿ®Ÿáÿß ÿ£ÿÆÿ∑ÿßÿ° ÿ∫Ÿäÿ± ŸÖÿ≠ŸÑŸàŸÑÿ© ŸÅŸä Ÿáÿ∞ÿß ÿßŸÑŸÇÿ≥ŸÖ.</p>
    </div>
    {% endif %}
    
    
</div>
{% endblock %}
